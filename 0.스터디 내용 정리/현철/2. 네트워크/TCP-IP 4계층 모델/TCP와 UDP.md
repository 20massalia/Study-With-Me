# TCP vs UDP

| 항목      | TCP                        | UDP                     |
| ------- | -------------------------- | ----------------------- |
| 프로토콜 종류 | **연결지향형(Connection-oriented)** | **비연결형(Connectionless)** |
| 신뢰성     | 높음 (데이터 순서 보장, 손실 시 재전송)   | 낮음 (순서 없음, 손실 보정 없음)    |
| 속도      | 느림 (오버헤드 존재)               | 빠름 (헤더 간단)              |
| 순서 보장   | O                          | X                       |
| 재전송     | O                          | X                       |
| 대표 사용처  | 웹 브라우징, 이메일, 파일 전송 등       | 스트리밍, 게임, VoIP 등 실시간성 중요할 때 |
| 헤더 크기   | 20 bytes                   | 8 bytes                 |
| 연결 절차   | 있음 (3-way handshake)       | 없음                      |

# TCP의 3-Way Handshake

TCP는 데이터를 주고 받기 전 연결을 먼저 설정한다. 이때 사용하는 절차가 TCP의 3-Way Handshake다.

[1] 클라이언트 → 서버 : SYN, SEQ = x  
[2] 서버 → 클라이언트 : SYN, ACK, SEQ = y, ACK = x + 1  
[3] 클라이언트 → 서버 : ACK, SEQ = x + 1, ACK = y + 1

| 단계            | 설명                                                              |
|---------------| --------------------------------------------------------------- |
| 1. 클라이언트 → 서버 | 클라이언트가 연결 요청을 보냄<br>→ `SYN=1`, `SEQ=x` (ISN=x)                  |
| 2. 서버 → 클라이언트 | 서버가 요청 수락 및 자기 ISN 전달<br>→ `SYN=1`, `ACK=1`, `SEQ=y`, `ACK=x+1` |
| 3. 클라이언트 → 서버 | 클라이언트가 응답<br>→ `ACK=1`, `SEQ=x+1`, `ACK=y+1`                    |

> ISN (Initial Sequence Number)
> 
> TCP 통신을 시작할 때 각 통신 주체가 랜덤하게 선택한 시작 시퀀스 번호
> 
> - TCP는 데이터의 순서 보장과 중복 방지를 위해 각 바이트에 시퀀스 번호를 붙임
> 
> - 이 번호가 바로 ISN
> 
> TCP는 오래 전에 닫힌 연결의 잔재 패킷이 네트워크를 떠돌 수도 있다고 가정하는데 만약 새로운 연결이 이전과 동일한 시퀀스 번호를 가진다면 래된 패킷과 새로운 패킷이 혼동될 수 있어 신뢰성이 깨질 수 있어 매 연결마다 고유한 ISN을 랜덤하게 부여하여 이런 충돌을 방지한다.
> 
> 또한, ISN을 예측 불가능하게 만들어 TCP 세션 하이재킹을 방지한다.

위 단계를 거친 후 양방향 데이터 송수신이 가능하다.

# TCP의 4-Way Handshake

연결을 끊을 때는 4번의 메시지 교환을 거친다.

[1] 클라이언트 → 서버 : FIN, SEQ = u  
[2] 서버 → 클라이언트 : ACK, SEQ = v, ACK = u + 1  
[3] 서버 → 클라이언트 : FIN, SEQ = v  
[4] 클라이언트 → 서버 : ACK, SEQ = u + 1, ACK = v + 1

| 단계          | 설명                                              |
|-------------| ----------------------------------------------- |
| 1. FIN(u)   | 클라이언트가 종료 요청<br>→ `FIN=1`, `SEQ=u`              |
| 2. ACK(u+1) | 서버가 수락<br>→ `ACK=1`, `SEQ=v`, `ACK=u+1`         |
| 3. FIN(v)   | 서버도 종료 요청<br>→ `FIN=1`, `SEQ=v`                 |
| 4. ACK(v+1) | 클라이언트가 최종 응답<br>→ `ACK=1`, `SEQ=u+1`, `ACK=v+1` |


> TIME_WAIT 이란 :
> 4-Way Handshake 마지막 단계에서 클라이언트는 연결을 바로 종료하지 않고 일정 시간 대기하는데 지연된 패킷으로 인한 충돌 방지, 안종한 종료 보장을 위해서다.

