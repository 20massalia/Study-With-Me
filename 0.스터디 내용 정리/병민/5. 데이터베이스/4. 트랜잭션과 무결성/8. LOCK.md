# 트랜잭션 Lock 락

- 여러 커넥션에서 동시에 동일한 자원을 요청할 경우 순서대로 하나의 커넥션만 변경할 수 있게 해주는 기능
- 동시성을 제어하기 위한 기능

DB에서 락을 획득한다는 의미는 뮤텍스처럼 데이터를 사용하는 주체가 잠그는 것이라고 볼 수 있습니다.

## 락의 종류

- 공유 락 (Shared Lock, Read Lock, S-Lock)
- 베타 락 (Exclusive Lock, Write Lock, X-Lock)

### 1. 공유 Lock

공유 락은 데이터를 변경하지 않는 읽기 작업을 위해 잠그는 것입니다.

륵정 데이터에 공유 락을 건다고 하면 아래와 같은 특징을 가집니다.

- 하나의 세션에서 읽기 작업 수행시 다른 세션에서 해당 데이터를 읽어도 데이터의 정합성은 지켜지기 때문에 다른 세션의 공유 락은 막을 필요가 없다.
- 하나의 세션에서 읽기 작업 수행시 다른 세션에서 해당 데이터에 쓰기 작업을 수행한다면 세션의 작업 결과가 달라질 수 있기 때문에 정합성이 지켜지지 않음으로 다른 세션의 베타 락 획들을 막는다.
- 다른 세션에서 해당 데이터에 공유 락을 걸고 접근할 수 있다.
- 다른 세션에서 해당 데이터에 베타 락을 걸고 접근할 수 없다.

즉, 아래와 같은 의미를 가집니다.

> 내가 데이터 읽는 동안 읽을 수는 있는데, 해당 데이터 변경하려고 선점하지 못한다(X-Lock을 걸 수 없다)

### 2. 베타 Lock

베타 락은 데이터를 변경하는 작업을 위해 잠그는 것을 말합니다.

륵정 데이터에 베타 락을 건다고 하면 아래와 같은 특징을 가집니다.

- 하나의 세션에서 쓰기 작업을 수행 시 다른 세션에서 해당 데이터를 읽는다면 작업 결과가 달라질 수 있기 때문에 데이터 정합성이 지켜지지 않으므로 다른 세션의 공유 락 획득은 막는다.
- 하나의 세션에서 쓰기 작업을 수행 시 다른 세션에서 해당 데이터 쓰기 작업을 한다면 기존 쓰기 작업 결과가 달라질 수 있기 때문에 데이터 정합성이 지켜지지 않으므로 다른 세션의 배타 락 획득은 막는다.
- 다른 세션에서 해당 데이터에 공유 Lock을 걸고 접근할 수 없다.
- 다른 세션에서 해당 데이터에 배타 Lock을 걸고 접근할 수 없다.

즉, 다음과 같은 의미를 가집니다.

> 내가 데이터를 쓸 동안 읽거나, 변경하지 못한다(X-Lock, S-Lock X)

## 블로킹 (Blocking)

보통 DB 작업을 수행할 때 데이터의 무결성과 정합성을 보장하기 위해 트랜잭션을 사용합니다.

따라서 Lock도 하나의 트랜잭션 안에서 걸리고, 해제되게 됩니다.

블로킹은 Lock 간의 경합이 발생해서 특정 트랜잭션이 작업을 진행하지 못하고 대기하는 상태를 의미합니다.

위의 공유 Lock, 배타 Lock 설명에서 블로킹 상태를 다음과 같이 언급했었습니다.

- 특정 데이터에 공유 Lock이 설정된 상태에서 해당 데이터에 배타 Lock을 설정하려고 할 때
- 특정 데이터에 배타 Lock이 설정된 상태에서 해당 데이터에 공유 Lock을 설정하려고 할 때
- 특정 데이터에 배타 Lock이 설정된 상태에서 해당 데이터에 공유 Lock을 설정하려고 할 때

![블로킹](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdna%2FcHthSM%2FbtszWH7nWRq%2FAAAAAAAAAAAAAAAAAAAAAGpdF1iRWRb-J1fr9lo0dtlKE29nSVj3SH-IphZtrPBE%2Fimg.png%3Fcredential%3DyqXZFxpELC7KVnFOS48ylbz2pIh7yKj8%26expires%3D1759244399%26allow_ip%3D%26allow_referer%3D%26signature%3D7x7oWhYQqlW7YyBJjdCJ5iRzbqE%253D)

Coupon 데이터에 트랜잭션 A가 S-Lock을 설정한 후에 트랜잭션 B가 X-Lock을 설정하여 트랜잭션 B가 블로킹 상태에 진입한 것을 알 수 있습니다.

### 해결방안

이러한 블로킹 상태에서 동시성에 관련하여 데이터 정합성을 보장하기 위해 락을 설정할 때에 블로킹 상태를 고려하여 설정해야합니다.

블로킹 상태가 길어지면 애플레케이션 서비스에서 해당 데이터를 사용하는 모든 작업이 지연되기 때문입니다.

따라서 아래와 같은 방법을 고려하여 구현해야 합니다.

1. 트랜잭션 작업 단위를 최대한 적게 구성 - JPA 사용시 간접 참조로 끊어 트랜잭션 작업단위를 적게 만들 수 있습니다.
2. 동일한 데이터를 동시에 변경하는 작업을 하지 않도록 설계 - 비관적 락, 난관적 락 방법을 통해 해결할 수 있습니다.
3. 트랜잭션이 활발한 주간에는 대용량 데이터 작업 수행을 지양 - 서비스 피크 타임에는 대용량 데이터 작업을 쪼개서 실행해야 합니다.

## Reference

https://ksh-coding.tistory.com/121